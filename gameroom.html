<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="resources/favicon_16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="resources/favicon_32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="resources/favicon_48x48.png" sizes="48x48" type="image/png">
    <link rel="icon" href="resources/favicon_192x192.png" sizes="192x192" type="image/png">
    <title>GameRoom</title>
    <link rel="stylesheet" href="css/gameroom.css">
</head>
<body>
    <header class="site-header">
        <div class="header-left">
            <a href="index.html" class="vicioware-icon-link">
                <img src="resources/vicioware_icon.png">
            </a>
            <a href="plataformas.html" class="plataformas-link">Plataformas</a>
        </div>
        <div class="header-center">
            <div class="searchbar-container">
                <input type="search" id="searchBar" placeholder="Buscar juegos...">
            </div>
        </div>
        <div class="header-right">
            <a href="#" class="backpack-icon-link" id="backpackIcon">
                <img src="resources/backpack.svg" alt="Mochila">
                <span class="backpack-counter" id="backpackCounter">0</span>
            </a>
            <div class="gameroom-icon-placeholder"></div>
        </div>
    </header>

    <div class="gallery-container"></div>
    <!-- La galería se cargará dinámicamente desde gallery-gameroom.html -->

    <!-- Modal del Juego -->
    <div id="gameModal" class="game-modal">
        <div class="game-modal-content">
            <span class="game-modal-close-button">&times;</span>
            <a href="#" class="iframe-download-button">
                <img src="resources/download.svg">
                <span class="download-text">Descargar</span>
            </a>
            <div class="modal-title-container">
                <h2 id="modalGameTitleText"></h2>
                <span class="info-icon-tooltip">
                    <img src="resources/info.svg"><span class="tooltip-text">Si el juego no carga, presiona F5</span>
                </span>
            </div>
            <iframe id="gameModalIframe" src="about:blank" frameborder="no" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true" scrolling="no"></iframe>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="custom-confirm-modal">
        <div class="custom-confirm-modal-content">
            <p id="customConfirmMessage">Perderás tu progreso en cuanto cierres la ventana. Puedes guardar tu partida presionando el ícono 'Save State'.</p>
            <div class="dont-show-again-container">
                <input type="checkbox" id="dontShowAgainCheckbox">
                <label for="dontShowAgainCheckbox">No mostrar este aviso otra vez</label>
            </div>
            <div class="custom-confirm-buttons">
                <button id="customConfirmCancelButton">Cancelar</button>
                <button id="customConfirmOkButton">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de la Mochila -->
    <div id="backpackModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="backpackCloseBtn">&times;</span>
            <h2>Mi Mochila</h2>
            <div id="backpackItems"></div>
            <div id="backpackActions" class="backpack-actions" style="display: none;">
                <button id="downloadAllBtn" class="download-all-btn">Descargar Todos</button>
                <button id="clearBackpackBtn" class="clear-backpack-btn">Vaciar Mochila</button>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- INICIALIZACIÓN DE GALERÍA DINÁMICA Y EVENTOS ---
    function initGallery() {
        const gameItems = document.querySelectorAll('.game-item');
        gameItems.forEach(item => {
            const img = item.querySelector('img');
            const originalSrc = img.getAttribute('src');
            const hoverSrc = item.dataset.hoverSrc;
            let hoverTimer = null;
            let isHoverImageDisplayed = false;

            function processLoadedImage() {
                img.style.opacity = '1';
            }
            if (img.complete && img.naturalWidth > 0) {
                processLoadedImage();
            }
            img.addEventListener('load', processLoadedImage);
            img.addEventListener('error', () => {
                img.style.opacity = '1';
            });

            item.addEventListener('mouseenter', () => {
                if (hoverSrc) {
                    if (hoverTimer) clearTimeout(hoverTimer);
                    hoverTimer = setTimeout(() => {
                        if (item.matches(':hover')) {
                            img.src = hoverSrc;
                            isHoverImageDisplayed = true;
                        }
                    }, 1000);
                }
            });
            item.addEventListener('mouseleave', () => {
                if (hoverTimer) {
                    clearTimeout(hoverTimer);
                    hoverTimer = null;
                }
                if (isHoverImageDisplayed) {
                    img.src = originalSrc;
                    isHoverImageDisplayed = false;
                }
            });

        });
    }
    window.initGallery = initGallery;

    // --- DELEGACIÓN DE EVENTOS PARA CLICS EN JUEGOS ---
    const galleryContainer = document.querySelector('.gallery-container');
    if (galleryContainer) {
        galleryContainer.addEventListener('click', (event) => {
            const gameItem = event.target.closest('.game-item');
            if (gameItem) {
                event.preventDefault();

                const gameSrc = gameItem.dataset.gameSrc;
                const gameTitle = gameItem.querySelector('p').textContent;
                const modal = document.getElementById('gameModal');
                const iframe = document.getElementById('gameModalIframe');
                const modalTitle = document.getElementById('modalGameTitleText');

                if (modal && iframe && modalTitle) {
                    modalTitle.textContent = gameTitle;
                    iframe.src = gameSrc;
                    modal.style.display = 'block';
                }
            }
        });
    }

    // --- CARGA DINÁMICA DE LA GALERÍA Y FILTRO ---
    fetch('gallery-gameroom.html')
        .then(response => response.text())
        .then(html => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const gallery = tempDiv.querySelector('.gallery-container');
            if (gallery) {
                document.querySelector('.gallery-container').innerHTML = gallery.innerHTML;
            }
            window.initGallery();

            // Filtro de búsqueda (debe ejecutarse después de cargar la galería)
            const searchBar = document.getElementById('searchBar');
            if (searchBar) {
                searchBar.addEventListener('input', (event) => {
                    const rawSearchTerm = event.target.value.trim().toLowerCase();
                    document.querySelectorAll('.game-item').forEach(item => {
                        const rawGameTitle = item.querySelector('p').textContent.toLowerCase();
                        if (rawGameTitle.includes(rawSearchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        });

    // --- LÓGICA DEL MODAL ---
    const modal = document.getElementById('gameModal');
    const closeButton = document.querySelector('.game-modal-close-button');
    const iframe = document.getElementById('gameModalIframe');

    if (closeButton && modal && iframe) {
        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
            iframe.src = 'about:blank'; // Detener la ejecución del juego
        });
    }

    // Cierra el modal si se hace clic fuera de su contenido
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
            iframe.src = 'about:blank'; // Detener la ejecución del juego
        }
    });
});
</script>
</body>
</html>